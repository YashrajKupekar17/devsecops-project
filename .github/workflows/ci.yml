name: CI Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install flake8 pytest

    # Code Quality Gate
    - name: Linting (flake8)
      run: flake8 app --max-line-length=100

    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

    # Unit Testing Gate
    - name: Unit Tests
      run: pytest tests/

    # SAST - Static Application Security Testing
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python

    - name: Run CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    # SCA - Dependency & Filesystem Scan
    - name: Trivy FS Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        severity: HIGH,CRITICAL

    # Docker Build
    - name: Build Docker Image
      run: docker build -t devsecops-fastapi:latest .

    # Container Security
    - name: Trivy Image Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: devsecops-fastapi:latest
        severity: HIGH,CRITICAL

    # Runtime Validation
    - name: Container Smoke Test
      run: |
        docker run -d -p 8000:8000 --name api-test devsecops-fastapi
        sleep 5
        curl http://localhost:8000/health
        docker rm -f api-test

    # Push Trusted Image
    - name: Login DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push Image
      run: |
        docker tag devsecops-fastapi:latest ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-fastapi:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-fastapi:latest
