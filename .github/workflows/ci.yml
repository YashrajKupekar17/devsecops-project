name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: pip install -r requirements.txt flake8 pytest

    # Code Quality
    - name: Lint with flake8
      run: flake8 app --max-line-length=100

    # Unit Tests
    - name: Run Tests
      run: pytest tests/

    # SAST using CodeQL
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    # SCA - Dependency Scan
    - name: Trivy FS Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        severity: HIGH,CRITICAL

    # Docker Build
    - name: Build Docker Image
      run: docker build -t devsecops-fastapi:latest .

    # Container Security Scan
    - name: Trivy Image Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: devsecops-fastapi:latest
        severity: HIGH,CRITICAL

    # Runtime Smoke Test
    - name: Run Container
      run: |
        docker run -d -p 8000:8000 --name api-test devsecops-fastapi
        sleep 5
        curl http://localhost:8000/health
        docker rm -f api-test

    # Push to DockerHub
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push Image
      run: |
        docker tag devsecops-fastapi ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-fastapi:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-fastapi:latest
